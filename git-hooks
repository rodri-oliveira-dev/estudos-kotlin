import json
import glob

# Definir as pastas que serão percorridas
DEV = {"ambiente": "998761750547", "caminho": "C:\\Users\\ogirdor\\projetos\\roles\\itau-ip5-infra-loyaltyitaushop-piperoles\\dev\\policy\\"}
HOMOL = {"ambiente": "241768922157", "caminho": "C:\\Users\\ogirdor\\projetos\\roles\\itau-ip5-infra-loyaltyitaushop-piperoles\\homolog\\policy\\"}
PROD = {"ambiente": "846159895675", "caminho": "C:\\Users\\ogirdor\\projetos\\roles\\itau-ip5-infra-loyaltyitaushop-piperoles\\prod\\policy\\"}

PARAMETRO_CHAVE = "Statement"

def validar():
    for ambiente in [DEV, HOMOL, PROD]:
        for arquivo in glob.glob(ambiente["caminho"] + "*.json"):
            with open(arquivo, "r") as f:
                data = json.load(f)
                if PARAMETRO_CHAVE in data:
                    for key in data[PARAMETRO_CHAVE]:
                        resources = key.get("Resource", None)
                        if resources:
                            if isinstance(resources, list):
                                for resource in resources:
                                    valida_resource(resource, arquivo, ambiente)
                            else:
                                valida_resource(resources, arquivo, ambiente)

def valida_resource(resource, arquivo, ambiente):
    if resource == "*" or resource.split(':')[4] == ambiente["ambiente"]:
        pass
    else:
        print(f"{arquivo} -> resource:{resource} inválido para o ambiente {ambiente['ambiente']}")

if __name__ == '__main__':
    validar()
